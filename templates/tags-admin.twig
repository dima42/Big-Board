{% extends 'loggedin.twig' %}

{% block filters %}
<ul class="nav nav-pills flex-column">
    <li class="nav-item">
        <a class="nav-link" href="/tags/admin">View</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/tags/edit">Edit</a>
    </li>
</ul>
{% endblock %}

{% block content %}
<h1>Tags</h1>
{% for scope_title, scope_tags in scopes %}
    <h2 data-tag data-level="{{ scope_tags.0.level }}" data-pk="{{ scope_tags.0.id }}">
        {{ scope_title }}
        <div class="float-right">
            <a class="badge badge-light" href="#" data-add-tag>+ Child</a>
        </div>
    </h2>
    {% for tag in scope_tags if tag.level > 0 %}
        <div class="tag level{{ tag.level }}" data-tag data-level="{{ tag.level }}" data-pk="{{ tag.id }}">
            {{ tag.title }}
            <a class="badge" href="http://{{ slackDomain }}.slack.com/messages/{{ tag.slackChannelId }}"><img src="/img/slack.png" width="12px" alt=""> Slack</a>
            <div class="float-right">
                <a class="badge badge-light" href="#" data-add-tag>+ Child</a>
            </div>
        </div>
    {% endfor %}
{% endfor %}
{% endblock %}

{% block scripts %}
<script id="add_tag" type="text_html">
{{ source('add_tag.mst') }}
</script>
<script>
$(function() {
    $('[data-add-tag]').click(function(e) {
        e.preventDefault();
        var template = $('#add_tag').html();
        var parent = $(this).closest('[data-tag]');
        var rendered = Mustache.render(template, {
            'parent': parent.data('pk'),
            'level': parent.data('level') + 1
        });
        parent.after(rendered);
        parent.next().find('input').first().focus();
    });
});
</script>
{% endblock %}
